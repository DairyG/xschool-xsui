<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<meta name="viewport">
		<title></title>
		<link rel="stylesheet" href="layui/css/layui.css" />
		<link rel="stylesheet" href="layui/css/style.css" />
		<link rel="stylesheet" href="layui/css/admin.css" />
		<script type="text/javascript" src="layui/layui.js"></script>
	</head>
	<style type="text/css">
		.layui-layout-admin .layui-body {
			bottom: 30px;
		}
	</style>

	<body>
		<div class="layui-layout layui-layout-admin">
			<div class="layui-header">
				<ul class="layui-nav padding0">
					<li class="layui-nav-item floatLeft">
						<p class="logo">
							<a href="javascript:;" title="菜单缩放" class="hideMenu layui-icon kit-side-fold padding0">&#xe668;</a>
							<img src="img/zx-logo.png" />
						</p>
					</li>
					<li class="layui-nav-item my_xinxi">
						<a href=""><img src="//t.cn/RCzsdCq" class="layui-nav-img">我</a>
						<dl class="layui-nav-child" style="left:-5px;">
							<dd>
								<a href="javascript:;">修改信息</a>
							</dd>
							<dd>
								<a href="javascript:;">安全管理</a>
							</dd>
							<dd>
								<a href="javascript:;">退了</a>
							</dd>
						</dl>
					</li>
				</ul>
				<div class="layui-tab mag0" id="top_tabs_box" lay-filter="Tab" style="position: absolute;left: 200px;right: 46px;height:100%; top: 0px;background: none;bottom: 0;">
					<div class="tab-go-refresh" id="J_refresh"><i class="layui-icon">&#xe669;</i></div>
					<div class="tab-go-left" id="page-prev"><i class="layui-icon">&#xe65a;</i></div>
					<ul class="layui-tab-title top_tab" id="B_history">
						<li class="layui-thisACtive" lay-id="default"><i class="layui-icon">&#xe68e;</i> 后台首页
						</li>
					</ul>
					<div class="tab-right">
						<div class="tab-go-right" id="page-next"><i class="layui-icon">&#xe65b;</i></div>
						<ul class="layui-nav closeBox">
							<li class="layui-nav-item">
								<a href="javascript:;"><i class="layui-icon">&#xe643;</i>&nbsp;页面操作<span class="layui-nav-more"></span></a>
								<dl class="layui-nav-child layui-anim layui-anim-upbit">
									<dd>
										<a href="javascript:;" class="closePageAll"><i class="layui-icon layui-icon-close"></i>&nbsp;关闭全部</a>
									</dd>
								</dl>
							</li>
						</ul>
					</div>
				</div>
			</div>
			<!--左侧  开始-->
			<div class="leftNav layui-side layui-bg-black">
				<div class="navBar layui-side-scroll" id="navBar">
					<ul class="layui-nav layui-nav-tree" lay-filter="test" id="B_menubar" lay-id="288cms">
						<li class="layui-nav-item" title="组织结构" class="tips3">
							<a href="javascript:;"><i class="layui-icon layui-icon-user fontsieze20"></i> <span>&nbsp;&nbsp;组织结构</span></a>
							<dl class="layui-nav-child">
								<dd>
									<a href="pages/部门管理/部门添加.html" lay-id="101cms"><span>部门管理</span></a>
								</dd>
								<dd>
									<a href="pages/部门管理/人员管理.html" lay-id="102cms"><span>人员管理</span></a>
								</dd>
								<dd>
									<a href="pages/部门管理/公司管理.html" lay-id="103cms"><span>公司管理</span></a>
								</dd>
							</dl>
						</li>
						<li class="layui-nav-item" title="权限管理">
							<a href="javascript:;" class="tips2"><i class="layui-icon layui-icon-auz fontsieze20"></i> <span>&nbsp;&nbsp;权限管理</span></a>
							<dl class="layui-nav-child">
								<dd>
									<a href="权限管理.html" lay-id="303cms"><span>权限管理</span></a>
								</dd>
								<dd>
									<a href="roleList.html" lay-id="296cms"><span>角色管理</span></a>
								</dd>
							</dl>
						</li>

					</ul>
				</div>
			</div>
			<!--左侧结束-->
			<!--内容-->
			<div class="layui-body" id="B_frame">
				<div class="layui-tab-contentBox clildFrame">
					<div class="iframe_box">
						<iframe id="iframe_default" src="home.html" style="height: 100%; width: 100%;" lay-id="default" frameborder="0" scrolling="auto"></iframe>
					</div>
				</div>
				<div class="layui-footer" style="height:30px;line-height: 30px;font-size:12px !important;">测试版本</div>
			</div>
		</div>
		<script type="text/javascript" src="lib/jquery-1.8.3.min.js"></script>
		<script>
			layui.use(['laydate', 'laypage', 'layer', 'table', 'carousel', 'upload', 'element', 'slider', 'form'], function() {
				var layer = layui.layer,
					element = layui.element,
					slider = layui.slider; //滑块
				//左侧栏缩放
				$('.kit-side-fold').click(function() {
					if($('.leftNav.layui-side.layui-bg-black').width() == 200) {
						$('.leftNav.layui-side.layui-bg-black').width(60);
						$('.layui-body').css('left', 60 + 'px');
						$('.layui-footer').css('left', 60 + 'px');
						$(".leftNav span").hide();
						$(".leftNav .layui-nav-item").removeClass('layui-nav-itemed')
						$(this).html('&#xe66b;')
					} else {
						$('.leftNav.layui-side.layui-bg-black').width(200);
						$('.layui-body').css('left', 200 + 'px');
						$('.layui-footer').css('left', 200 + 'px');
						$(".leftNav span").show();
						$(this).html('&#xe668;')
					}
				});
				//缩小之后在点击LI放大
				$('.leftNav li').click(function() {
					if($('.leftNav.layui-side.layui-bg-black').width() == 60) {
						$('.leftNav.layui-side.layui-bg-black').width(200);
						$('.layui-body').css('left', 200 + 'px');
						$('.layui-footer').css('left', 200 + 'px');
						$(".leftNav span").show();
						$('.kit-side-fold').html('&#xe668;')
					}
				})

				var SUBMENU_CONFIG = {};
				var openTabNum = 100; //最大可打开窗口数量
				//iframe 加载事件
				var iframe_default = document.getElementById('iframe_default');
				var def_iframe_height = 0;
				$(iframe_default.contentWindow.document).ready(function() {
					$(iframe_default).show();
				});
				var html = [];
				$.each(SUBMENU_CONFIG, function(i, o) {
					html.push('<li class="layui-nav-item"><a href="javascript:;" title="' + o.title + '" lay-id="' + o.id + '"><i class="iconfont ' + o.icon + '"></i>&nbsp;' + o.title + '</a></li>');
				});
				$('#J_B_main_block').html(html.join(''));
				element.render(); //重新渲染
				//顶部导航点击
				$('#J_B_main_block').on('click', 'a', function(e) {
					//取消事件的默认动作
					e.preventDefault();
					//终止事件 不再派发事件
					e.stopPropagation();
					$(this).parent().addClass('current').siblings().removeClass('current');
					var data_id = $(this).attr('lay-id'),
						data_list = SUBMENU_CONFIG[data_id],
						html = [],
						child_html = [],
						child_index = 0,
						B_menubar = $('#B_menubar');

					if(B_menubar.attr('lay-id') == data_id) {
						return false;
					};
					//显示左侧菜单
					//console.log(data_list['items']);
					show_left_menu(data_list['items']);
					B_menubar.html(html.join('')).attr('lay-id', data_id);
					element.render(); //重新渲染
					//显示左侧菜单
					function show_left_menu(data) {
						for(var attr in data) {
							if(data[attr] && typeof(data[attr]) === 'object') {
								//循环子对象
								if(!data[attr].url && attr === 'items') {
									//子菜单添加识别属性
									$.each(data[attr], function(i, o) {
										child_index++;
										o.isChild = true;
										o.child_index = child_index;
									});
								}
								show_left_menu(data[attr]); //继续执行循环(筛选子菜单)
							} else {
								if(attr === 'title') {
									data.url = data.url ? data.url : '#';
									if(!(data['isChild'])) {
										//一级菜单
										html.push('<li class="layui-nav-item layui-nav-itemed"><a href="' + data.url + '" lay-id="' + data.id + '"><i class="iconfont ' + data.icon + '"></i>&nbsp;<b>' + data.title + '</b></a>');
									} else {
										//二级菜单
										child_html.push('<dd><a href="' + data.url + '" lay-id="' + data.id + '"><i class="iconfont ' + data.icon + '"></i>&nbsp;' + data.title + '</a></dd>');
										//二级菜单全部push完毕
										if(data.child_index == child_index) {
											html.push('<dl class="layui-nav-child">' + child_html.join('') + '</dl></li>');
											child_html = [];
										}
									}
								}
							}
						}
					};
				});

				//后台位在第一个导航
				$('#J_B_main_block li:first > a').trigger("click");

				//左边菜单点击
				$('#B_menubar').on('click', 'a', function(e) {
					e.preventDefault();
					e.stopPropagation();
					var $this = $(this),
						_dt = $this.parent(),
						_dl = $this.next('dl');
					if(_dl.length) {
						return false;
					};
					if($("#B_history li").length == openTabNum) {
						layer.msg('只能同时打开' + openTabNum + '个选项卡哦。不然系统会卡的！');
						return;
					}
					var data_id = $(this).attr('lay-id'),
						li = $('#B_history li[lay-id=' + data_id + ']');
					var href = this.href;
					console.log(href)

					iframeJudge({
						elem: $this,
						href: href,
						id: data_id
					});

				});

				//判断显示或创建iframe
				function iframeJudge(options) {
					var elem = options.elem,
						href = options.href,
						id = options.id,
						li = $('#B_history li[lay-id=' + id + ']');
					//如果iframe标签是已经存在的，则显示并让选项卡高亮,并不显示loading
					if(li.length > 0) {
						var iframe = $('#iframe_' + id);
						setTimeout(function() {
							$('#loading').hide();
						}, 500);
						li.addClass('current');
						if(iframe[0].contentWindow && iframe[0].contentWindow.location.href !== href) {
							iframe[0].contentWindow.location.href = href;
						}
						$('#B_frame iframe').hide();
						$('#iframe_' + id).show();
						showTab(li); //计算此tab的位置，如果不在屏幕内，则移动导航位置
					} else {
						//创建一个并加以标识
						var iframeAttr = {
							src: href,
							id: 'iframe_' + id,
							frameborder: '0',
							scrolling: 'auto',
							height: '100%',
							width: '100%'
						};
						var iframe = $('<iframe/>').prop(iframeAttr).appendTo('#B_frame .layui-tab-contentBox .iframe_box');

						$(iframe[0].contentWindow.document).ready(function() {
							$('#B_frame iframe').hide();
							setTimeout(function() {
								$('#loading').hide();
							}, 500);
							var li = $('<li>' + elem.html() + '<i class="layui-icon layui-unselect layui-tab-close">&#x1006;</i></li>').attr('lay-id', id);
							li.appendTo('#B_history');
							showTab(li); //计算此tab的位置，如果不在屏幕内，则移动导航位置
							//$(this).show().unbind('load');
						});
					}
				}

				//点击一个tab页
				$('#B_history').on('click focus', 'li', function(e) {
					e.preventDefault();
					e.stopPropagation();
					var data_id = $(this).attr('lay-id');
					if(data_id) {
						//选择顶部菜单
						var curid = data_id;
						if(curid == "default") curid = "changyong";
						var topmenu = getTopMenuByID(curid);
						var objtopmenu = $('#J_B_main_block').find("a[lay-id=" + topmenu.id + "]");
						if(objtopmenu.parent().attr("class") != "layui-thisACtive") {
							//选中当前顶部菜单
							objtopmenu.parent().addClass('layui-thisACtive').siblings().removeClass('layui-thisACtive');
							//触发事件
							objtopmenu.click();
						}
						//选择左边菜单
						$("#B_menubar").find(".layui-thisACtive").removeClass('layui-thisACtive');
						$("#B_menubar").find("a[lay-id=" + data_id + "]").parent().addClass('layui-thisACtive');
					}

					$(this).addClass('layui-thisACtive').siblings('li').removeClass('layui-thisACtive');
					$('#iframe_' + data_id).show().siblings('iframe').hide(); //隐藏其它iframe
				});

				//关闭一个tab页
				$('#B_history').on('click', '.layui-tab-close', function(e) {
					e.stopPropagation();
					e.preventDefault();
					var li = $(this).parent(),
						prev_li = li.prev('li'),
						data_id = li.attr('lay-id');
					li.hide(60, function() {
						$(this).remove(); //移除选项卡
						$('#iframe_' + data_id).remove(); //移除iframe页面
						var current_li = $('#B_history li.layui-thisACtive');
						//找到关闭后当前应该显示的选项卡
						current_li = current_li.length ? current_li : prev_li;
						current_li.addClass('layui-thisACtive');
						cur_data_id = current_li.attr('lay-id');
						$('#iframe_' + cur_data_id).show();
					});
				});

				//上一个选项卡
				$('#page-prev').click(function(e) {
					e.preventDefault();
					e.stopPropagation();
					var ul = $('#B_history'),
						current = ul.find('.layui-thisACtive'),
						li = current.prev('li');
					showTab(li);
				});

				//下一个选项卡
				$('#page-next').click(function(e) {
					e.preventDefault();
					e.stopPropagation();
					var ul = $('#B_history'),
						current = ul.find('.layui-thisACtive'),
						li = current.next('li');
					showTab(li);
				});

				//显示顶部导航时作位置判断，点击左边菜单、上一tab、下一tab时公用
				function showTab(li) {
					if(li.length) {
						var ul = $('#B_history'),
							li_offset = li.offset(),
							li_width = li.outerWidth(true),
							next_left = $('#page-next').offset().left, //右边按钮的界限位置
							prev_right = $('#page-prev').offset().left + $('#page-prev').outerWidth(true); //左边按钮的界限位置
						if(li_offset.left + li_width > next_left) { //如果将要移动的元素在不可见的右边，则需要移动
							var distance = li_offset.left + li_width - next_left; //计算当前父元素的右边距离，算出右移多少像素
							ul.animate({
								left: '-=' + distance
							}, 200, 'swing');
						} else if(li_offset.left < prev_right) { //如果将要移动的元素在不可见的左边，则需要移动
							var distance = prev_right - li_offset.left; //计算当前父元素的左边距离，算出左移多少像素
							ul.animate({
								left: '+=' + distance
							}, 200, 'swing');
						}
						li.trigger('click');
					}
				}

				//刷新
				$('#J_refresh').click(function(e) {
					e.preventDefault();
					e.stopPropagation();
					var index = layer.load();
					var id = $('#B_history .layui-thisACtive').attr('lay-id'),
						iframe = $('#iframe_' + id);
					if(iframe[0].contentWindow) {
						//common.js
						reloadPage(iframe[0].contentWindow);
						layer.close(index);
					}
				});

				//关闭全部选项卡
				$(".closePageAll").on("click", function() {
					if($("#B_history li").length > 1) {
						$("#B_history li").each(function() {
							data_id = $(this).attr('lay-id');
							if(data_id != '' && data_id != 'default') {
								//$(this).remove(); //移除选项卡
								element.tabDelete("Tab", data_id);
								$('#iframe_' + data_id).remove(); //移除iframe页面
								$('#iframe_default').show();
							}
						})

					} else {
						layer.msg("没有可以关闭的窗口了@_@");
					}

				})

				//通过菜单id查找菜单配置对象
				function getMenuByID(mid, menugroup) {
					var ret = {};
					mid = parseInt(mid);
					if(!menugroup) menugroup = SUBMENU_CONFIG;
					if(isNaN(mid)) {
						ret = menugroup['changyong'];
					} else {
						$.each(menugroup, function(i, o) {
							if(o.id && parseInt(o.id) == mid) {
								ret = o;
								return false
							} else if(o.items) {
								var tmp = getMenuByID(mid, o.items);
								if(tmp.id && parseInt(tmp.id) == mid) {
									ret = tmp;
									return false
								}
							}
						});
					}
					return ret;
				}

				function getTopMenuByID(mid) {
					var ret = {};
					var menu = getMenuByID(mid);
					if(menu) {
						if(menu.parent) {
							var tmp = getTopMenuByID(menu.parent);
							if(tmp && tmp.id) {
								ret = tmp;
							}
						} else {
							ret = menu;
						}
					}
					return ret;
				}

				//重新刷新页面，使用location.reload()有可能导致重新提交
				function reloadPage(win) {
					var location = win.location;
					location.href = location.pathname + location.search;
				}

			})
		</script>

	</body>

</html>